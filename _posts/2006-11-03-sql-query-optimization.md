---
id: 93
title: SQL query optimization
date: 2006-11-03T12:29:11+00:00


guid: /post/2006/11/SQL-query-optimization.aspx
permalink: /2006/11/sql-query-optimization/
dsq_thread_id:
  - "78197416"
categories:
  - SQL
---
<p>Wow. Two SQL posts on the same day.</p>
<p>The SQL query processing team <a href="http://blogs.msdn.com/sqlqueryprocessing/default.aspx">blog</a> is quite a gem. I wonder how I missed this.</p>
<blockquote dir="ltr" style="MARGIN-RIGHT: 0px">
<p>The query processing team - query optimization &amp; execution - providing tips, tricks, advice and answers to frequently-asked questions in a continued effort to make your queries run faster and smoother in SQL Server.</p></blockquote>
<p dir="ltr">BTW: I consider <a href="http://msdn2.microsoft.com/en-us/library/ms190623.aspx">this short article</a> a must read for everyone who writes a SELECT query. The reason is that we never learn about the query optimizer in school when learning about databases.</p>
<p dir="ltr">Let me prove this to you. My best friend Shasheendra&nbsp;wrote this code the other day&nbsp;and it stumped me.&nbsp;Imagine this, you want to insert 10,000 rows into a temporary table.&nbsp; Let&rsquo;s say we can take two approaches. The first one is to simply write 10,000 inserts the second could be to&nbsp;insert the entries into a&nbsp;table with a single field with&nbsp;the 10,000 being comma delimited. Then parse the string and&nbsp;insert each row at a time. </p>
<p dir="ltr">Which do you think runs faster? No hurries, just take a look at the code and then scroll down to see the time comparison.</p>
<p dir="ltr"><strong>Approach 1: </strong></p>
<p dir="ltr">Write 10,000 insert statements. Like this</p><font color="#0000ff" size="2">
<p>CREATE</font><font size="2"> </font><font color="#0000ff" size="2">TABLE</font><font size="2"> #filetab </font><font color="#808080" size="2">(</font><font color="#0000ff" size="2">filename</font><font size="2"> </font><font color="#0000ff" size="2">varchar</font><font color="#808080" size="2">(</font><font size="2">256</font><font color="#808080" size="2">))</font><font size="2"> </p></font><font color="#0000ff" size="2">
<p>CREATE</font><font size="2"> </font><font color="#0000ff" size="2">CLUSTERED</font><font size="2"> </font><font color="#0000ff" size="2">INDEX</font><font size="2"> IX_filetab </font><font color="#0000ff" size="2">ON</font><font size="2"> #filetab </font><font color="#808080" size="2">(</font><font color="#0000ff" size="2">filename</font><font color="#808080" size="2">)</p></font><font color="#0000ff" size="2">
<p>INSERT</font><font size="2"> </font><font color="#0000ff" size="2">INTO</font><font size="2"> #filetab </font><font color="#0000ff" size="2">VALUES</font><font size="2"> </font><font color="#808080" size="2">(</font><font color="#ff0000" size="2">'dummy'</font><font color="#808080" size="2">)</p></font><font color="#0000ff" size="2">
<p><strong>INSERT</strong></font><strong><font size="2"> </font><font color="#0000ff" size="2">INTO</font><font size="2"> #filetab </font><font color="#0000ff" size="2">VALUES</font><font size="2"> </font><font color="#808080" size="2">(</font><font color="#ff0000" size="2">'ed7d1eda-025b-41be-b8b4-523dc9d53ece'</font><font color="#808080" size="2">)</p></font></strong><font color="#0000ff" size="2">
<p>INSERT</font><font size="2"> </font><font color="#0000ff" size="2">INTO</font><font size="2"> #filetab </font><font color="#0000ff" size="2">VALUES</font><font size="2"> </font><font color="#808080" size="2">(</font><font color="#ff0000" size="2">'b61abf2e-3252-423c-9ad7-cc63cb5e51bc'</font><font color="#808080" size="2">)</p></font><font color="#0000ff" size="2">
<p>INSERT</font><font size="2"> </font><font color="#0000ff" size="2">INTO</font><font size="2"> #filetab </font><font color="#0000ff" size="2">VALUES</font><font size="2"> </font><font color="#808080" size="2">(</font><font color="#ff0000" size="2">'4224b7f8-120a-447b-a8ae-63cefce78255'</font><font color="#808080" size="2">)</font></p><font color="#808080" size="2"><font color="#0000ff" size="2">
<p>&hellip;.(10,000 entries)&hellip;</p>
<p>INSERT</font><font color="#000000" size="2"> </font><font color="#0000ff" size="2">INTO</font><font color="#000000" size="2"> #filetab </font><font color="#0000ff" size="2">VALUES</font><font color="#000000" size="2"> </font><font color="#808080" size="2">(</font><font color="#ff0000" size="2">'7f38bed5-be32-42c8-986f-20b3c78950ad'</font><font color="#808080" size="2">)</p></font><font color="#0000ff" size="2">
<p>SELECT</font><font color="#000000" size="2"> </font><font color="#ff00ff" size="2">COUNT</font><font color="#808080" size="2">(*)</font><font color="#000000" size="2"> </font><font color="#0000ff" size="2">FROM</font><font size="2"><font color="#000000"> #filetab</font></p></font><font color="#0000ff" size="2">
<p>DROP</font><font color="#000000" size="2"> </font><font color="#0000ff" size="2">TABLE</font><font size="2"><font color="#000000"> #filetab</font></p>
<p>GO</p></font></font>
<p dir="ltr"><strong>Approach 2:</strong></p><font color="#0000ff" size="2">
<p>DECLARE</font><font size="2"> @filelisttab </font><font color="#0000ff" size="2">TABLE</font><font size="2"> </font><font color="#808080" size="2">(</font><font size="2">filelist </font><font color="#0000ff" size="2">text</font><font color="#808080" size="2">)</p></font><font color="#0000ff" size="2">
<p>CREATE</font><font size="2"> </font><font color="#0000ff" size="2">TABLE</font><font size="2"> #filetab </font><font color="#808080" size="2">(</font><font color="#0000ff" size="2">filename</font><font size="2"> </font><font color="#0000ff" size="2">varchar</font><font color="#808080" size="2">(</font><font size="2">256</font><font color="#808080" size="2">))</font><font size="2"> </p></font><font color="#0000ff" size="2">
<p>CREATE</font><font size="2"> </font><font color="#0000ff" size="2">CLUSTERED</font><font size="2"> </font><font color="#0000ff" size="2">INDEX</font><font size="2"> IX_filetab </font><font color="#0000ff" size="2">ON</font><font size="2"> #filetab </font><font color="#808080" size="2">(</font><font color="#0000ff" size="2">filename</font><font color="#808080" size="2">)</p></font><font color="#0000ff" size="2">
<p>INSERT</font><font size="2"> </font><font color="#0000ff" size="2">INTO</font><font size="2"> @filelisttab </font><font color="#808080" size="2">(</font><font size="2">filelist</font><font color="#808080" size="2">)</font><font size="2"> </font><font color="#0000ff" size="2">VALUES</font><font size="2"> </font><font color="#808080" size="2">(</font><font color="#ff0000" size="2">'dummy,ed7d1eda-025b-41be-b8b4-523dc9d53ece,b61abf2e <font color="#0000ff">&hellip;.(10,000 comma seperated entries)&hellip;<font color="#ff0000" size="2">,7f38bed5-be32-42c8-986f-20b3c78950ad'</font><font color="#808080" size="2">)</p></font></font></font><font color="#0000ff" size="2">
<p>DECLARE</font><font size="2"> @i </font><font color="#0000ff" size="2">int</font><font color="#808080" size="2">,</font><font size="2"> @l </font><font color="#0000ff" size="2">int</font><font color="#808080" size="2">,</font><font size="2"> @tl </font><font color="#0000ff" size="2">int</p>
<p>SET</font><font size="2"> @i </font><font color="#808080" size="2">=</font><font size="2"> 1</p></font><font color="#0000ff" size="2">
<p>SELECT</font><font size="2"> @tl </font><font color="#808080" size="2">=</font><font size="2"> </font><font color="#ff00ff" size="2">DATALENGTH</font><font color="#808080" size="2">(</font><font size="2">filelist</font><font color="#808080" size="2">)</font><font size="2"> </font><font color="#0000ff" size="2">FROM</font><font size="2"> @filelisttab</p></font><font color="#0000ff" size="2">
<p>WHILE</font><font size="2"> </font><font color="#808080" size="2">(</font><font size="2">@i </font><font color="#808080" size="2">&lt;</font><font size="2"> @tl</font><font color="#808080" size="2">)</p></font><font color="#0000ff" size="2">
<p>BEGIN</p></font><font size="2">
<p></font><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; DECLARE</font><font size="2"> @filename </font><font color="#0000ff" size="2">Varchar</font><font color="#808080" size="2">(</font><font size="2">256</font><font color="#808080" size="2">)</p></font><font size="2">
<p></font><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; DECLARE</font><font size="2"> @nextcommat </font><font color="#0000ff" size="2">int</p></font><font size="2">
<p></font><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; SELECT</font><font size="2"> @filename </font><font color="#808080" size="2">=</font><font size="2"> </font><font color="#ff00ff" size="2">SUBSTRING</font><font color="#808080" size="2">(</font><font size="2">filelist</font><font color="#808080" size="2">,</font><font size="2"> @i</font><font color="#808080" size="2">,</font><font size="2"> 128</font><font color="#808080" size="2">)</font><font size="2"> </font><font color="#0000ff" size="2">FROM</font><font size="2"> @filelisttab </font><font color="#008000" size="2">-- Use 128 character read buffer!</p></font><font size="2">
<p></font><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; SET</font><font size="2"> @nextcommat </font><font color="#808080" size="2">=</font><font size="2"> </font><font color="#ff00ff" size="2">CHARINDEX</font><font color="#808080" size="2">(</font><font color="#ff0000" size="2">','</font><font color="#808080" size="2">,</font><font size="2"> @filename</font><font color="#808080" size="2">)</p></font><font size="2">
<p></font><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; SET</font><font size="2"> @l </font><font color="#808080" size="2">=</font><font size="2"> </font><font color="#0000ff" size="2">CASE</font><font size="2"> @nextcommat </font><font color="#0000ff" size="2">WHEN</font><font size="2"> 0 </font><font color="#0000ff" size="2">THEN</font><font size="2"> 128 </font><font color="#0000ff" size="2">ELSE</font><font size="2"> </font><font color="#808080" size="2">(</font><font size="2">@nextcommat</font><font color="#808080" size="2">-</font><font size="2">1</font><font color="#808080" size="2">)</font><font size="2"> </font><font color="#0000ff" size="2">END</p></font><font size="2">
<p></font><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; SET</font><font size="2"> @filename </font><font color="#808080" size="2">=</font><font size="2"> </font><font color="#ff00ff" size="2">SUBSTRING</font><font color="#808080" size="2">(</font><font size="2">@filename</font><font color="#808080" size="2">,</font><font size="2"> 1</font><font color="#808080" size="2">,</font><font size="2"> @l</font><font color="#808080" size="2">)</p></font><font size="2">
<p></font><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; IF</font><font size="2"> </font><font color="#808080" size="2">(</font><font color="#ff00ff" size="2">LEN</font><font color="#808080" size="2">(</font><font size="2">@filename</font><font color="#808080" size="2">)&gt;</font><font size="2">0</font><font color="#808080" size="2">)</font><font size="2"> </font><strong><font color="#0000ff" size="2">INSERT</font><font size="2"> </font><font color="#0000ff" size="2">INTO</font><font size="2"> #filetab </font><font color="#808080" size="2">(</font><font color="#0000ff" size="2">filename</font><font color="#808080" size="2">)</font><font size="2"> </font><font color="#0000ff" size="2">VALUES</font><font size="2"> </font><font color="#808080" size="2">(</font><font size="2">@filename</font><font color="#808080" size="2">)</p></font></strong><font size="2">
<p></font><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; SET</font><font size="2"> @i </font><font color="#808080" size="2">=</font><font size="2"> @i </font><font color="#808080" size="2">+</font><font size="2"> @l </font><font color="#808080" size="2">+</font><font size="2"> 1</p></font><font color="#0000ff" size="2">
<p>END</p>
<p>SELECT</font><font size="2"> </font><font color="#ff00ff" size="2">COUNT</font><font color="#808080" size="2">(*)</font><font size="2"> </font><font color="#0000ff" size="2">FROM</font><font size="2"> #filetab</p></font><font color="#0000ff" size="2">
<p>DROP</font><font size="2"> </font><font color="#0000ff" size="2">TABLE</font><font size="2"> #filetab</p>
<p dir="ltr"></font><a href="https://merill.net/wp-content/uploads/binary/Query1.sql">Query1.sql (722 KB)</a></p>
<p dir="ltr"><a href="https://merill.net/wp-content/uploads/binary/Query2.sql">Query2.sql (401 KB)</a></p>
<p dir="ltr">&nbsp;</p>
<p dir="ltr">If you don&rsquo;t believe me, you can download the two sql statements and try running them on your machine. These scripts create a temporary table, insert data and then drop the table.</p>
<p dir="ltr"><em>Query 1&nbsp;: First run 2 min 48 seconds, second run 2 min 28 seconds</em></p>
<p dir="ltr"><em>Query 2:&nbsp;&nbsp;First run 9 seconds, second run 5 seconds</em></p>
<p dir="ltr">And here I was thinking all these days that I knew all the basics on SQL query optimization.</p>